{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="mb-0">Relatórios de Contratos</h1>
        <a href="{{ url_for('exportar_relatorios', **request.args) }}" class="btn btn-outline-secondary">
            <i class="bi bi-download"></i> Exportar
        </a>
    </div>

    <div style="display: flex; flex-wrap: wrap; gap: 2rem; margin-bottom: 2rem;">
        <div style="flex: 1 1 300px; max-width: 600px;">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    Resumo por Instituição
                </div>
                <div class="card-body">
                    <canvas id="instituicaoChart" style="max-width:100%; height:auto;"></canvas>
                </div>
            </div>
        </div>

        <div style="flex: 1 1 300px; max-width: 600px;">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    Distribuição por Indexador
                </div>
                <div class="card-body">
                    <canvas id="indexadorChart" style="max-width:100%; height:auto;"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            Filtros
        </div>
        <div class="card-body">
            <form method="GET" action="{{ url_for('relatorios') }}" class="row g-3">
                <div class="col-md-3">
                    <label for="instituicao_filtro" class="form-label">Instituição</label>
                    <input type="text" id="instituicao_filtro" name="instituicao" class="form-control" value="{{ request.args.get('instituicao', '') }}" autocomplete="off" placeholder="Digite o nome ou código do banco">
                    <div id="autocomplete-bancos-filtro" class="list-group position-absolute w-100" style="z-index: 1000;"></div>
                </div>
                <div class="col-md-3">
                    <label for="produto" class="form-label">Produto</label>
                    <select id="produto" name="produto" class="form-select">
                        <option value="todos">Todos</option>
                        <option value="CDC - Veículo">CDC - Veículo</option>
                        <option value="CAPITAL DE GIRO - Pré">CAPITAL DE GIRO - Pré</option>
                        <option value="FINAME">FINAME</option>
                        <option value="CAPITAL DE GIRO - Pós">CAPITAL DE GIRO - Pós</option>
                        <option value="CDC - Outros">CDC - Outros</option>
                        <option value="Leasing">Leasing</option>
                        <option value="Finan. Forcedores">Finan. Forcedores</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="modalidade" class="form-label">Modalidade</label>
                    <select id="modalidade" name="modalidade" class="form-select">
                        <option value="">Todas</option>
                        <option value="pre" {% if request.args.get('modalidade') == 'pre' %}selected{% endif %}>Pré-Fixado</option>
                        <option value="pos" {% if request.args.get('modalidade') == 'pos' %}selected{% endif %}>Pós-Fixado</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="status" class="form-label">Status</label>
                    <select id="status" name="status" class="form-select">
                        <option value="">Todos</option>
                        <option value="ativos" {% if request.args.get('status') == 'ativos' %}selected{% endif %}>Ativos</option>
                        <option value="quitados" {% if request.args.get('status') == 'quitados' %}selected{% endif %}>Quitados</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="numero_contrato" class="form-label">Número do Contrato</label>
                    <input type="text" id="numero_contrato" name="numero_contrato" class="form-control" value="{{ request.args.get('numero_contrato', '') }}" placeholder="Número do Contrato">
                </div>
                <div class="col-md-3">
                    <label for="ano" class="form-label">Ano</label>
                    <input type="number" id="ano" name="ano" class="form-control" value="{{ request.args.get('ano', '') }}" placeholder="Ano (ex: 2024)" min="1900" max="2100">
                </div>
                <div class="col-md-3">
                    <label for="mes" class="form-label">Mês</label>
                    <input type="number" id="mes" name="mes" class="form-control" value="{{ request.args.get('mes', '') }}" placeholder="Mês (1-12)" min="1" max="12">
                </div>
                <div class="col-md-3 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="bi bi-funnel"></i> Filtrar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div style="overflow-x:auto;">
        <table class="table table-striped table-hover align-middle">
            <thead class="table-dark">
                <tr>
                    <th>Contrato</th>
                    <th>Empresa</th>
                    <th>Instituição</th>
                    <th>Saldo Inicial</th>
                    <th>Principal Pend.</th>
                    <th>Juros Pend.</th>
                    <th>Total Pend.</th>
                    <th>Data de Fim</th>
                </tr>
            </thead>
            <tbody>
                {% for contrato in contratos %}
                <tr>
                    <td>{{ contrato.contrato }}</td>
                    <td>{{ contrato.empresa_nome }}</td>
                    <td>{{ contrato.instituicao }}</td>
                    <td>{{ contrato.saldo_inicial|brl }}</td>
                    <td>{{ contrato.principal_pendente|brl }}</td>
                    <td>{{ contrato.juros_pendente_calculado|brl }}</td>
                    <td>{{ ((contrato.principal_pendente or 0) + (contrato.juros_pendente or 0))|brl }}</td>
                    <td>
                        {% if contrato.data_fim_calculada %}
                            {{ contrato.data_fim_calculada.strftime('%d/%m/%Y') }}
                        {% else %}
                            -
                        {% endif %}
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="8" class="text-center">Nenhum contrato encontrado.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Nova Tabela de Relatório -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            Relatório de Bancos
        </div>
        <div class="card-body">
            <table class="table table-striped table-hover align-middle">
                <thead class="table-dark">
                    <tr>
                        <th>Bancos</th>
                        <th>Montante</th>
                        <th>%</th>
                        <th>CP</th>
                        <th>LP</th>
                        <th>%CP</th>
                        <th>%LP</th>
                        <th>Ativos</th>
                        <th>Liquidados</th>
                    </tr>
                </thead>
                <tbody>
                    {% for banco in bancos %}
                    <tr>
                        <td>{{ banco.nome }}</td>
                        <td>{{ banco.montante|brl }}</td>
                        <td>{{ banco.percentual }}%</td>
                        <td>{{ banco.cp }}</td>
                        <td>{{ banco.lp }}</td>
                        <td>{{ banco.percentual_cp }}%</td>
                        <td>{{ banco.percentual_lp }}%</td>
                        <td>{{ banco.ativos }}</td>
                        <td>{{ banco.liquidados }}</td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="9" class="text-center">Nenhum banco encontrado.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    // Gráfico por instituição
    const instituicaoCtx = document.getElementById('instituicaoChart').getContext('2d');
    const instituicaoChart = new Chart(instituicaoCtx, {
        type: 'bar',
        data: {
            labels: {{ instituicao_labels|tojson }},
            datasets: [{
                label: 'Valor Total (R$)',
                data: {{ instituicao_data|tojson }},
                backgroundColor: 'rgba(54, 162, 235, 0.7)',
                borderColor: 'rgba(54, 162, 235,1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        color: '#222'
                        }
                },
                x: {
                    ticks: {
                        color: '#222'
                    }
                }
            }
        }
    });

    // Gráfico por indexador
    const indexadorCtx = document.getElementById('indexadorChart').getContext('2d');
    const indexadorChart = new Chart(indexadorCtx, {
        type: 'pie',
        data: {
            labels: {{ indexador_labels|tojson }},
            datasets: [{
                label: 'Distribuição',
                data: {{ indexador_data|tojson }},
                backgroundColor: [
                    'rgba(54, 162, 235, 0.7)',
                    'rgba(255, 99, 132, 0.7)',
                    'rgba(75, 192, 192, 0.7)',
                    'rgba(255, 206, 86, 0.7)'
                ],
                borderColor: '#fff',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { position: 'right' },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.raw || 0;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = Math.round((value / total) * 100);
                            return `${label}: R$ ${value.toLocaleString()} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
</script>
{% endblock %}
{% endblock %}
